{% extends "base.html" %}

{% block title %}Videos - You Hoard{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">Videos</h1>
    <p class="page-subtitle">Browse and manage your downloaded videos</p>
</div>

<!-- Filters and Search -->
<div class="card mb-6">
    <div class="card-body">
        <div class="filters-row">
            <div class="search-group">
                <input type="text" id="search-input" placeholder="Search videos..." class="search-input">
                <button id="search-btn" class="btn btn-primary">Search</button>
            </div>
            
            <div class="filter-group">
                <select id="status-filter" class="filter-select">
                    <option value="">All Status</option>
                    <option value="completed">Downloaded</option>
                    <option value="downloading">Downloading</option>
                    <option value="pending">Pending</option>
                    <option value="failed">Failed</option>
                </select>
                
                <select id="channel-filter" class="filter-select">
                    <option value="">All Channels</option>
                </select>
                
                <button id="clear-filters" class="btn btn-secondary">Clear</button>
            </div>
        </div>
    </div>
</div>

<!-- Videos Grid -->
<div class="videos-grid" id="videos-grid">
    <div class="loading-placeholder">Loading videos...</div>
</div>

<!-- Pagination -->
<div class="pagination-wrapper" id="pagination-wrapper" style="display: none;">
    <div class="pagination-info">
        <span id="pagination-info-text"></span>
    </div>
    <div class="pagination-controls">
        <button id="prev-page" class="btn btn-secondary" disabled>Previous</button>
        <span id="page-numbers"></span>
        <button id="next-page" class="btn btn-secondary" disabled>Next</button>
    </div>
</div>

<!-- Video Detail Modal -->
<div class="modal" id="video-detail-modal">
    <div class="modal-content modal-large">
        <div class="modal-header">
            <h3 id="video-detail-title">Video Details</h3>
            <button class="modal-close" id="close-video-detail">&times;</button>
        </div>
        <div class="modal-body">
            <div id="video-detail-content">
                <!-- Video details will be loaded here -->
            </div>
        </div>
    </div>
</div>

<style>
.filters-row {
    display: flex;
    gap: var(--space-4);
    align-items: center;
    flex-wrap: wrap;
}

.search-group {
    display: flex;
    gap: var(--space-2);
    flex: 1;
    min-width: 300px;
}

.search-input {
    flex: 1;
    padding: var(--space-2) var(--space-3);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    background: var(--surface);
    color: var(--text);
    font-size: 0.875rem;
}

.search-input:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: var(--glow-primary);
}

.filter-group {
    display: flex;
    gap: var(--space-2);
    align-items: center;
}

.filter-select {
    padding: var(--space-2);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    background: var(--surface);
    color: var(--text);
    font-size: 0.875rem;
    min-width: 120px;
}

.filter-select:focus {
    outline: none;
    border-color: var(--primary);
}

.videos-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: var(--space-4);
    margin-bottom: var(--space-6);
}

.video-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    overflow: hidden;
    transition: all 0.2s ease;
    cursor: pointer;
}

.video-card:hover {
    border-color: var(--primary);
    box-shadow: var(--glow-primary);
    transform: translateY(-2px);
}

.video-thumbnail {
    width: 100%;
    height: 180px;
    background: var(--surface-hover);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2rem;
    color: var(--text-secondary);
    position: relative;
}

.video-thumbnail img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.video-status-badge {
    position: absolute;
    top: var(--space-2);
    right: var(--space-2);
    padding: var(--space-1) var(--space-2);
    border-radius: var(--radius-sm);
    font-size: 0.75rem;
    font-weight: 500;
    text-transform: uppercase;
}

.status-completed {
    background: rgba(0, 255, 136, 0.2);
    color: var(--terminal-green);
    border: 1px solid rgba(0, 255, 136, 0.3);
}

.status-downloading {
    background: rgba(0, 170, 255, 0.2);
    color: #00aaff;
    border: 1px solid rgba(0, 170, 255, 0.3);
}

.status-pending {
    background: rgba(255, 170, 0, 0.2);
    color: var(--terminal-amber);
    border: 1px solid rgba(255, 170, 0, 0.3);
}

.status-failed {
    background: rgba(255, 51, 68, 0.2);
    color: var(--error);
    border: 1px solid rgba(255, 51, 68, 0.3);
}

.video-info {
    padding: var(--space-3);
}

.video-title {
    font-size: 0.875rem;
    font-weight: 600;
    line-height: 1.4;
    margin-bottom: var(--space-2);
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.video-meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.75rem;
    color: var(--text-secondary);
}

.video-channel {
    font-weight: 500;
}

.video-duration {
    font-family: var(--font-mono);
}

.pagination-wrapper {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-4) 0;
    border-top: 1px solid var(--border);
}

.pagination-controls {
    display: flex;
    gap: var(--space-2);
    align-items: center;
}

.page-numbers {
    display: flex;
    gap: var(--space-1);
    margin: 0 var(--space-2);
}

.page-number {
    padding: var(--space-1) var(--space-2);
    border: 1px solid var(--border);
    background: var(--surface);
    color: var(--text);
    text-decoration: none;
    border-radius: var(--radius-sm);
    font-size: 0.875rem;
    transition: all 0.2s ease;
}

.page-number:hover {
    border-color: var(--primary);
    background: var(--surface-hover);
}

.page-number.active {
    background: var(--primary);
    border-color: var(--primary);
    color: white;
}

.modal-large {
    max-width: 800px;
}

.video-detail-grid {
    display: grid;
    grid-template-columns: 1fr 300px;
    gap: var(--space-6);
}

.video-detail-main {
    display: flex;
    flex-direction: column;
    gap: var(--space-4);
}

.video-detail-sidebar {
    display: flex;
    flex-direction: column;
    gap: var(--space-4);
}

.detail-section {
    background: var(--surface-hover);
    padding: var(--space-3);
    border-radius: var(--radius);
    border: 1px solid var(--border);
}

.detail-section h4 {
    margin-bottom: var(--space-2);
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--primary);
}

.detail-meta {
    display: grid;
    grid-template-columns: auto 1fr;
    gap: var(--space-2) var(--space-3);
    font-size: 0.875rem;
}

.detail-meta .label {
    font-weight: 500;
    color: var(--text-secondary);
}

.detail-actions {
    display: flex;
    gap: var(--space-2);
    flex-wrap: wrap;
}

@media (max-width: 768px) {
    .filters-row {
        flex-direction: column;
        align-items: stretch;
    }
    
    .search-group {
        min-width: unset;
    }
    
    .videos-grid {
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    }
    
    .pagination-wrapper {
        flex-direction: column;
        gap: var(--space-3);
    }
    
    .video-detail-grid {
        grid-template-columns: 1fr;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
class VideosPage {
    constructor() {
        this.currentPage = 1;
        this.perPage = 20;
        this.currentFilters = {
            search: '',
            status: '',
            channel_id: ''
        };
        
        this.init();
    }
    
    async init() {
        this.setupEventListeners();
        await this.loadChannels();
        await this.loadVideos();
    }
    
    setupEventListeners() {
        // Search
        const searchInput = document.getElementById('search-input');
        const searchBtn = document.getElementById('search-btn');
        
        searchBtn.addEventListener('click', () => this.handleSearch());
        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') this.handleSearch();
        });
        
        // Filters
        document.getElementById('status-filter').addEventListener('change', (e) => {
            this.currentFilters.status = e.target.value;
            this.resetAndSearch();
        });
        
        document.getElementById('channel-filter').addEventListener('change', (e) => {
            this.currentFilters.channel_id = e.target.value;
            this.resetAndSearch();
        });
        
        document.getElementById('clear-filters').addEventListener('click', () => {
            this.clearFilters();
        });
        
        // Pagination
        document.getElementById('prev-page').addEventListener('click', () => {
            if (this.currentPage > 1) {
                this.currentPage--;
                this.loadVideos();
            }
        });
        
        document.getElementById('next-page').addEventListener('click', () => {
            this.currentPage++;
            this.loadVideos();
        });
        
        // Modal
        document.getElementById('close-video-detail').addEventListener('click', () => {
            youHoard.hideModal('video-detail-modal');
        });
    }
    
    async loadChannels() {
        try {
            const response = await youHoard.apiCall('/api/channels?per_page=100');
            const channelFilter = document.getElementById('channel-filter');
            
            // Clear existing options except "All Channels"
            channelFilter.innerHTML = '<option value="">All Channels</option>';
            
            if (response.channels) {
                response.channels.forEach(channel => {
                    const option = document.createElement('option');
                    option.value = channel.id;
                    option.textContent = channel.name;
                    channelFilter.appendChild(option);
                });
            }
        } catch (error) {
            console.error('Failed to load channels:', error);
        }
    }
    
    async loadVideos() {
        try {
            const params = new URLSearchParams({
                page: this.currentPage,
                per_page: this.perPage
            });
            
            // Add filters
            if (this.currentFilters.search) {
                params.append('search', this.currentFilters.search);
            }
            if (this.currentFilters.status) {
                params.append('status', this.currentFilters.status);
            }
            if (this.currentFilters.channel_id) {
                params.append('channel_id', this.currentFilters.channel_id);
            }
            
            const response = await youHoard.apiCall(`/api/videos?${params}`);
            this.renderVideos(response.videos || []);
            this.renderPagination(response);
            
        } catch (error) {
            console.error('Failed to load videos:', error);
            this.renderError('Failed to load videos');
        }
    }
    
    renderVideos(videos) {
        const grid = document.getElementById('videos-grid');
        
        if (videos.length === 0) {
            grid.innerHTML = `
                <div class="loading-placeholder" style="grid-column: 1 / -1;">
                    No videos found. Try adjusting your filters or <a href="#" onclick="youHoard.showModal('add-video-modal')">add some videos</a>!
                </div>
            `;
            return;
        }
        
        grid.innerHTML = videos.map(video => `
            <div class="video-card" onclick="videosPage.showVideoDetail(${video.id})">
                <div class="video-thumbnail">
                    ${video.thumbnail_url ? 
                        `<img src="${video.thumbnail_url}" alt="${youHoard.escapeHtml(video.title)}" onerror="this.style.display='none'">` :
                        'ðŸŽ¬'
                    }
                    <div class="video-status-badge status-${video.download_status}">
                        ${video.download_status}
                    </div>
                </div>
                <div class="video-info">
                    <div class="video-title">${youHoard.escapeHtml(video.title)}</div>
                    <div class="video-meta">
                        <span class="video-channel">${youHoard.escapeHtml(video.channel_name || 'Unknown Channel')}</span>
                        <span class="video-duration">${this.formatDuration(video.duration)}</span>
                    </div>
                </div>
            </div>
        `).join('');
    }
    
    renderPagination(response) {
        const wrapper = document.getElementById('pagination-wrapper');
        const info = document.getElementById('pagination-info-text');
        const prevBtn = document.getElementById('prev-page');
        const nextBtn = document.getElementById('next-page');
        const pageNumbers = document.getElementById('page-numbers');
        
        if (!response.total || response.total === 0) {
            wrapper.style.display = 'none';
            return;
        }
        
        wrapper.style.display = 'flex';
        
        // Update info
        const start = ((this.currentPage - 1) * this.perPage) + 1;
        const end = Math.min(this.currentPage * this.perPage, response.total);
        info.textContent = `Showing ${start}-${end} of ${response.total} videos`;
        
        // Update buttons
        prevBtn.disabled = this.currentPage === 1;
        const totalPages = Math.ceil(response.total / this.perPage);
        nextBtn.disabled = this.currentPage >= totalPages;
        
        // Update page numbers
        pageNumbers.innerHTML = this.generatePageNumbers(this.currentPage, totalPages);
    }
    
    generatePageNumbers(current, total) {
        const pages = [];
        const showPages = 5;
        let start = Math.max(1, current - Math.floor(showPages / 2));
        let end = Math.min(total, start + showPages - 1);
        
        if (end - start < showPages - 1) {
            start = Math.max(1, end - showPages + 1);
        }
        
        for (let i = start; i <= end; i++) {
            pages.push(`
                <a href="#" class="page-number ${i === current ? 'active' : ''}" 
                   onclick="videosPage.goToPage(${i}); return false;">
                    ${i}
                </a>
            `);
        }
        
        return pages.join('');
    }
    
    goToPage(page) {
        this.currentPage = page;
        this.loadVideos();
    }
    
    handleSearch() {
        const searchInput = document.getElementById('search-input');
        this.currentFilters.search = searchInput.value.trim();
        this.resetAndSearch();
    }
    
    resetAndSearch() {
        this.currentPage = 1;
        this.loadVideos();
    }
    
    clearFilters() {
        document.getElementById('search-input').value = '';
        document.getElementById('status-filter').value = '';
        document.getElementById('channel-filter').value = '';
        
        this.currentFilters = {
            search: '',
            status: '',
            channel_id: ''
        };
        
        this.resetAndSearch();
    }
    
    async showVideoDetail(videoId) {
        try {
            const video = await youHoard.apiCall(`/api/videos/${videoId}`);
            this.renderVideoDetail(video);
            youHoard.showModal('video-detail-modal');
        } catch (error) {
            console.error('Failed to load video details:', error);
            youHoard.showToast('Failed to load video details', 'error');
        }
    }
    
    renderVideoDetail(video) {
        const content = document.getElementById('video-detail-content');
        const title = document.getElementById('video-detail-title');
        
        title.textContent = video.title;
        
        content.innerHTML = `
            <div class="video-detail-grid">
                <div class="video-detail-main">
                    <div class="detail-section">
                        <h4>Description</h4>
                        <p>${video.description ? youHoard.escapeHtml(video.description).substring(0, 500) + (video.description.length > 500 ? '...' : '') : 'No description available'}</p>
                    </div>
                    
                    <div class="detail-section">
                        <h4>Video Information</h4>
                        <div class="detail-meta">
                            <span class="label">Channel:</span>
                            <span>${youHoard.escapeHtml(video.channel_name)}</span>
                            
                            <span class="label">Duration:</span>
                            <span>${this.formatDuration(video.duration)}</span>
                            
                            <span class="label">Upload Date:</span>
                            <span>${video.upload_date ? new Date(video.upload_date).toLocaleDateString() : 'Unknown'}</span>
                            
                            <span class="label">Views:</span>
                            <span>${video.view_count ? this.formatNumber(video.view_count) : 'Unknown'}</span>
                            
                            <span class="label">Likes:</span>
                            <span>${video.like_count ? this.formatNumber(video.like_count) : 'Unknown'}</span>
                        </div>
                    </div>
                </div>
                
                <div class="video-detail-sidebar">
                    <div class="detail-section">
                        <h4>Download Status</h4>
                        <div class="video-status-badge status-${video.download_status}">
                            ${video.download_status}
                        </div>
                        <p style="margin-top: var(--space-2); font-size: 0.875rem; color: var(--text-secondary);">
                            ${this.getStatusDescription(video.download_status)}
                        </p>
                    </div>
                    
                    <div class="detail-section">
                        <h4>File Information</h4>
                        <div class="detail-meta">
                            <span class="label">Size:</span>
                            <span>${video.file_size ? this.formatFileSize(video.file_size) : 'N/A'}</span>
                            
                            <span class="label">Quality:</span>
                            <span>${video.quality || 'N/A'}</span>
                            
                            <span class="label">Path:</span>
                            <span style="word-break: break-all; font-family: var(--font-mono); font-size: 0.75rem;">
                                ${video.file_path || 'N/A'}
                            </span>
                        </div>
                    </div>
                    
                    <div class="detail-section">
                        <h4>Actions</h4>
                        <div class="detail-actions">
                            ${video.download_status === 'pending' || video.download_status === 'failed' ? 
                                `<button class="btn btn-primary btn-sm" onclick="videosPage.downloadVideo(${video.id})">Download</button>` : ''
                            }
                            <a href="https://www.youtube.com/watch?v=${video.youtube_id}" target="_blank" class="btn btn-secondary btn-sm">View on YouTube</a>
                            <button class="btn btn-danger btn-sm" onclick="videosPage.deleteVideo(${video.id})">Delete</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    
    async downloadVideo(videoId) {
        try {
            await youHoard.apiCall(`/api/videos/${videoId}/download`, {
                method: 'POST',
                body: JSON.stringify({ priority: 5 })
            });
            
            youHoard.showToast('Video queued for download', 'success');
            youHoard.hideModal('video-detail-modal');
            this.loadVideos(); // Refresh the list
        } catch (error) {
            console.error('Failed to queue download:', error);
            youHoard.showToast('Failed to queue download', 'error');
        }
    }
    
    async deleteVideo(videoId) {
        if (!confirm('Are you sure you want to delete this video? This action cannot be undone.')) {
            return;
        }
        
        try {
            await youHoard.apiCall(`/api/videos/${videoId}`, { method: 'DELETE' });
            youHoard.showToast('Video deleted successfully', 'success');
            youHoard.hideModal('video-detail-modal');
            this.loadVideos(); // Refresh the list
        } catch (error) {
            console.error('Failed to delete video:', error);
            youHoard.showToast('Failed to delete video', 'error');
        }
    }
    
    renderError(message) {
        const grid = document.getElementById('videos-grid');
        grid.innerHTML = `
            <div class="loading-placeholder" style="grid-column: 1 / -1; color: var(--error);">
                ${message}
            </div>
        `;
    }
    
    formatDuration(seconds) {
        if (!seconds) return 'Unknown';
        
        const hours = Math.floor(seconds / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        const secs = seconds % 60;
        
        if (hours > 0) {
            return `${hours}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        } else {
            return `${minutes}:${secs.toString().padStart(2, '0')}`;
        }
    }
    
    formatNumber(num) {
        if (num >= 1000000) {
            return (num / 1000000).toFixed(1) + 'M';
        } else if (num >= 1000) {
            return (num / 1000).toFixed(1) + 'K';
        }
        return num.toString();
    }
    
    formatFileSize(bytes) {
        const units = ['B', 'KB', 'MB', 'GB'];
        let size = bytes;
        let unitIndex = 0;
        
        while (size >= 1024 && unitIndex < units.length - 1) {
            size /= 1024;
            unitIndex++;
        }
        
        return `${size.toFixed(1)} ${units[unitIndex]}`;
    }
    
    getStatusDescription(status) {
        const descriptions = {
            'completed': 'Video has been successfully downloaded',
            'downloading': 'Video is currently being downloaded',
            'pending': 'Video is waiting to be downloaded',
            'failed': 'Download failed - try downloading again'
        };
        return descriptions[status] || 'Unknown status';
    }
}

// Initialize when page loads
let videosPage;
document.addEventListener('DOMContentLoaded', () => {
    videosPage = new VideosPage();
});
</script>
{% endblock %} 